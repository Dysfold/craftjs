"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const java_io_1 = require("java.io");
const java_nio_file_1 = require("java.nio.file");
function walk(file, callback) {
    if (!file.isDirectory()) {
        callback(file);
        return;
    }
    for (const f of file.listFiles()) {
        walk(f, callback);
    }
}
function getTestBaseDir(base) {
    if (!base) {
        return __jsdir;
    }
    if (base[0] === '.') {
        return java_nio_file_1.Paths.get(__jsdir, base).toString();
    }
    const pluginDir = java_nio_file_1.Paths.get(__jsdir, 'plugins', base).toString();
    return pluginDir;
}
function runTests(base) {
    const baseDir = new java_io_1.File(getTestBaseDir(base));
    const testFiles = [];
    walk(baseDir, (f) => {
        if (!f.getName().match(/\.test\.js$/g) ||
            f.getPath().match('node_modules') // Exclude tests of node_modules
        ) {
            return;
        }
        testFiles.push(f);
    });
    const ownPath = new java_io_1.File(__filename).toPath().getParent();
    testFiles.forEach((f) => {
        const relative = ownPath.relativize(f.toPath());
        require(`./${f.getPath()}`, '.');
    });
}
async function runner() {
    const env = java.lang.System.getenv('CRAFTJS_ENV');
    console.log(`craftjs_env=${env}`);
    if (env === 'test') {
        runTests();
        try {
            await __zoraHarness.report();
            if (!__zoraHarness.pass) {
                throw new Error();
            }
            java.lang.Runtime.getRuntime().halt(0);
        }
        catch (_a) {
            java.lang.Runtime.getRuntime().halt(1);
        }
    }
}
runner();
global.runTests = runTests;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZXN0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEscUNBQStCO0FBQy9CLGlEQUFzQztBQU90QyxTQUFTLElBQUksQ0FBQyxJQUFVLEVBQUUsUUFBOEI7SUFDdEQsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRTtRQUN2QixRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDZixPQUFPO0tBQ1I7SUFDRCxLQUFLLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRTtRQUNoQyxJQUFJLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQ25CO0FBQ0gsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLElBQWE7SUFDbkMsSUFBSSxDQUFDLElBQUksRUFBRTtRQUNULE9BQU8sT0FBTyxDQUFDO0tBQ2hCO0lBQ0QsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFO1FBQ25CLE9BQU8scUJBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0tBQzVDO0lBQ0QsTUFBTSxTQUFTLEdBQUcscUJBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNqRSxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBRUQsU0FBUyxRQUFRLENBQUMsSUFBYTtJQUM3QixNQUFNLE9BQU8sR0FBRyxJQUFJLGNBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUMvQyxNQUFNLFNBQVMsR0FBVyxFQUFFLENBQUM7SUFDN0IsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFO1FBQ2xCLElBQ0UsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQztZQUNsQyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDLGdDQUFnQztVQUNsRTtZQUNBLE9BQU87U0FDUjtRQUNELFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLE9BQU8sR0FBRyxJQUFJLGNBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUUxRCxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7UUFDdEIsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUNoRCxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNuQyxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxLQUFLLFVBQVUsTUFBTTtJQUNuQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDbEMsSUFBSSxHQUFHLEtBQUssTUFBTSxFQUFFO1FBQ2xCLFFBQVEsRUFBRSxDQUFDO1FBQ1gsSUFBSTtZQUNGLE1BQU0sYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQzdCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFO2dCQUN2QixNQUFNLElBQUksS0FBSyxFQUFFLENBQUM7YUFDbkI7WUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDeEM7UUFBQyxXQUFNO1lBQ04sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3hDO0tBQ0Y7QUFDSCxDQUFDO0FBRUQsTUFBTSxFQUFFLENBQUM7QUFFVCxNQUFNLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyJ9